# Нахождение самого длинного маршрута

![License](https://img.shields.io/github/license/VitalinaZlo/IT-planeta2024_SberTex_PostgreSQL?style=flat-square&color=e5573e&label=License)
![PostgreSQL](https://img.shields.io/badge/build-17-brightgreen?style=flat-square&label=PostgreSQL&color=032677)
![Status](https://img.shields.io/badge/build-completed-green?style=flat-square&label=Status&color=3dc322)


**Finding the longest route** — это проект, предназначенный для нахождения маршрута в базе данных `PostgreSQL` с максимальным количеством станций в заданные даты, учитывая расписание поездов, условия пересадок и ограничения.

Данный проект был создан для второго тура чемпионата «IT-Планета Pro 2024» в конкурсе «Работа с СУБД Pangolin» от СберТеха. Проект занял шестое место в полуфинале.

## Задача проекта

С помощью одного запроса найти маршрут с максимальным количеством станций (включая промежуточные), соблюдая следующие условия:

- Отправление — в даты проведения второго этапа конкурса, с 05/11/2024 по 17/11/2024 (включительно);
- Маршрут должен учитывать годовое расписание поездов, включая признаки отправления по четным/нечетным числам и дням недели;
- Маршрут должен пересекать одну станцию только один раз, включая промежуточные;
- Станция отправления — любая начальная станция любого поезда, станция прибытия — любая конечная станция любого поезда;
- Пересадка с поезда на поезд осуществляется на одной станции, а не в пределах населенного пункта (иначе говоря — не из любого вокзала города, а с вокзала прибытия);
- Пересадки могут происходить на конечных станциях следования, при этом время ожидания следующего рейса не менее 40 минут и не более 8 часов (включительно);
- Создание дополнительных объектов в БД не разрешается.

## Структура исходных данных

База данных PostgreSQL 17.0 (`trains.pgdmp`) с таблицами, содержащими информацию о поездах, маршрутах и расписаниях.

Схема базы данных:

![trains_schema](https://github.com/user-attachments/assets/90312bca-2abc-44aa-9e47-1a7756b456f9)

## Принцип работы кода

Запрос использует CTE (Common Table Expressions) для поэтапной обработки данных, начиная с получения максимального номера станции для каждого поезда и заканчивая выбором маршрута с максимальным количеством станций. Запрос учитывает все заданные условия и ограничения.

## Структура запроса

1. **`search_max_station`**: Получение максимального номера станции для каждого поезда;
2. **`date_ranges`**: Извлечение данных о расписании поездов и разбивка на интервалы;
3. **`expanded_dates`**: Генерация всех возможных дат для каждого поезда в заданных интервалах;
4. **`filtered_dates`**: Фильтрация дат по заданному диапазону;
5. **`dates_departure_and_arrival`**: Вычисление дат отправления и прибытия для каждого поезда;
6. **`joining_tables`**: Объединение данных о датах с максимальными номерами станций;
7. **`matching_dates`**: Поиск поездов, на которые можно пересесть, учитывая время ожидания;
8. **`non_coincidence_intermediate_stations`**: Отсеивание пар поездов с совпадающими промежуточными станциями;
9. **`best_route`**: Выбор маршрута с максимальным общим количеством станций.
